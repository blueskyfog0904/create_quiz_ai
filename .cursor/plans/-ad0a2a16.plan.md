<!-- ad0a2a16-60fa-42b3-8c3a-a77d210ec120 adbf7ba2-2a66-4b46-83ae-3ef975961784 -->
# 관리자 문제 업로드 및 커뮤니티 은행 기능

## 개요

관리자가 문제를 직접 업로드하고, 사용자가 커뮤니티 은행에서 문제를 자신의 문제 은행에 저장할 수 있는 기능을 구현합니다.

## 데이터베이스 마이그레이션

### questions 테이블 수정

```sql
-- source 컬럼 추가
ALTER TABLE questions 
ADD COLUMN source VARCHAR(20) DEFAULT 'ai_generated' CHECK (source IN ('ai_generated', 'admin_uploaded', 'from_community'));

-- shared_question_id 컬럼 추가 (커뮤니티에서 가져온 문제의 원본 ID)
ALTER TABLE questions 
ADD COLUMN shared_question_id UUID REFERENCES questions(id);

-- 기존 데이터를 'ai_generated'로 업데이트
UPDATE questions SET source = 'ai_generated' WHERE source IS NULL;
```

## 1. 관리자 권한 확인 유틸리티

**파일**: `src/lib/auth.ts` (수정)

```typescript
export async function requireAdmin() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    redirect('/login')
  }
  
  const { data: profile } = await supabase
    .from('profiles')
    .select('is_admin')
    .eq('id', user.id)
    .single()
  
  if (!profile?.is_admin) {
    redirect('/') // 또는 403 에러 페이지
  }
  
  return user
}
```

## 2. Admin 문제 업로드 페이지

### 2.1 서버 컴포넌트

**파일**: `src/app/(dashboard)/admin/questions/upload/page.tsx` (생성)

```typescript
import { requireAdmin } from '@/lib/auth'
import { createClient } from '@/lib/supabase/server'
import AdminUploadClient from './admin-upload-client'

export default async function AdminUploadPage() {
  await requireAdmin()
  const supabase = await createClient()
  
  // 문제 유형 가져오기
  const { data: problemTypes } = await supabase
    .from('problem_types')
    .select('*')
    .eq('is_active', true)
    .order('type_name')
  
  return (
    <div className="container mx-auto py-8 px-4">
      <h1 className="text-3xl font-bold mb-2">관리자 문제 업로드</h1>
      <p className="text-gray-500 mb-8">커뮤니티에 공유할 문제를 직접 업로드합니다.</p>
      <AdminUploadClient problemTypes={problemTypes || []} />
    </div>
  )
}
```

### 2.2 클라이언트 컴포넌트

**파일**: `src/app/(dashboard)/admin/questions/upload/admin-upload-client.tsx` (생성)

- 문제 입력 폼 (question_text, passage_text, answer, choices, explanation, difficulty, grade_level, problem_type_id)
- AI 생성 문제와 동일한 구조
- 제출 시 API 호출 (`/api/admin/questions/upload`)

### 2.3 API 라우트

**파일**: `src/app/api/admin/questions/upload/route.ts` (생성)

```typescript
export async function POST(request: Request) {
  // 1. 관리자 권한 확인
  // 2. 요청 데이터 검증 (Zod)
  // 3. questions 테이블에 저장
  //    - user_id: 'admin' (고정값)
  //    - source: 'admin_uploaded'
  //    - shared_question_id: NULL
  // 4. 성공 응답 반환
}
```

## 3. 커뮤니티 은행 페이지

### 3.1 서버 컴포넌트

**파일**: `src/app/(dashboard)/community-bank/page.tsx` (생성)

```typescript
import { requireAuth } from '@/lib/auth'
import { createClient } from '@/lib/supabase/server'
import CommunityBankClient from './community-bank-client'

export default async function CommunityBankPage() {
  await requireAuth()
  const supabase = await createClient()
  
  // 관리자가 업로드한 문제 조회
  const { data: questions } = await supabase
    .from('questions')
    .select('*, problem_types(type_name)')
    .eq('source', 'admin_uploaded')
    .order('created_at', { ascending: false })
  
  // 필터용 데이터
  const { data: problemTypes } = await supabase
    .from('problem_types')
    .select('id, type_name')
    .eq('is_active', true)
  
  return <CommunityBankClient questions={questions || []} problemTypes={problemTypes || []} />
}
```

### 3.2 클라이언트 컴포넌트

**파일**: `src/app/(dashboard)/community-bank/community-bank-client.tsx` (생성)

- 문제 목록 표시 (카드 형태)
- 필터링 (문제 유형, 학년, 난이도)
- 정렬 (최신순, 오래된 순)
- 각 문제에 "내 문제 은행에 저장" 버튼
- 저장 시 API 호출 (`/api/questions/save-from-community`)

### 3.3 API 라우트

**파일**: `src/app/api/questions/save-from-community/route.ts` (생성)

```typescript
export async function POST(request: Request) {
  // 1. 인증 확인
  // 2. 원본 문제 ID 받기
  // 3. 원본 문제 데이터 조회
  // 4. 사용자의 questions 테이블에 복사본 생성
  //    - user_id: 현재 사용자 ID
  //    - source: 'from_community'
  //    - shared_question_id: 원본 문제 ID
  //    - 나머지 필드는 원본과 동일
  // 5. 중복 저장 방지 (이미 저장한 문제인지 확인)
  // 6. 성공 응답 반환
}
```

## 4. 기존 문제 은행 페이지 수정

### 4.1 bank-client.tsx 수정

**파일**: `src/app/(dashboard)/bank/bank-client.tsx`

#### 변경사항:

1. source 필터 추가
   ```typescript
   const [selectedSource, setSelectedSource] = useState<string>('all')
   ```

2. 필터링 로직에 source 추가
   ```typescript
   if (selectedSource !== 'all' && question.source !== selectedSource) {
     return false
   }
   ```

3. UI에 source 필터 드롭다운 추가 (grid-cols-5 → grid-cols-6)
   ```tsx
   <Select value={selectedSource} onValueChange={setSelectedSource}>
     <SelectItem value="all">전체</SelectItem>
     <SelectItem value="ai_generated">AI생성문제</SelectItem>
     <SelectItem value="from_community">문제은행</SelectItem>
     <SelectItem value="admin_uploaded">관리자업로드</SelectItem>
   </Select>
   ```

4. 초기화 함수에 source 추가
   ```typescript
   setSortBy('latest')
   setSelectedSource('all')
   ```


### 4.2 question-list.tsx 수정

**파일**: `src/components/features/bank/question-list.tsx`

- 각 문제 카드에 source 태그 표시
  ```tsx
  <Badge variant={question.source === 'ai_generated' ? 'default' : 'secondary'}>
    {question.source === 'ai_generated' ? 'AI생성문제' : '문제은행'}
  </Badge>
  ```


## 5. 네비게이션 추가

### 5.1 Admin 메뉴 (관리자만 표시)

**파일**: `src/components/layout/navigation.tsx` (또는 해당 파일)

- is_admin이 true인 사용자에게만 "관리자 > 문제 업로드" 메뉴 표시

### 5.2 커뮤니티 은행 링크

- 사이드바 또는 네비게이션에 "커뮤니티 은행" 링크 추가

## 6. 타입 정의 업데이트

### 6.1 supabase.ts 업데이트

데이터베이스 마이그레이션 후 `npx supabase gen types typescript` 실행하여 타입 재생성

## 구현 순서

1. 데이터베이스 마이그레이션 (source, shared_question_id 컬럼 추가)
2. 타입 정의 업데이트
3. 관리자 권한 확인 유틸리티 구현
4. Admin 문제 업로드 페이지 구현 (서버 + 클라이언트 + API)
5. 커뮤니티 은행 페이지 구현 (서버 + 클라이언트 + API)
6. 기존 문제 은행 페이지에 source 필터 및 태그 추가
7. 네비게이션 메뉴 업데이트
8. 테스트

## 주요 기능

- 관리자는 `/admin/questions/upload`에서 문제 직접 업로드
- 모든 사용자는 `/community-bank`에서 관리자 업로드 문제 조회
- 사용자는 원하는 문제를 자신의 문제 은행에 저장
- 문제 은행에서 'AI생성문제'와 '문제은행' 태그로 구분
- source 필터로 문제 출처별 조회 가능

### To-dos

- [ ] 정렬 상태 useState 추가
- [ ] 필터링/정렬 로직 수정 (useMemo)
- [ ] 그리드 레이아웃 4컬럼 → 5컬럼 변경
- [ ] 정렬 드롭다운 UI 추가
- [ ] 초기화 함수에 정렬 초기화 추가